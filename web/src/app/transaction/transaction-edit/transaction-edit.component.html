<form [formGroup]="form" (ngSubmit)="onSubmit()">
  <app-toolbar title="Tranzakció">
    <button mat-icon-button type="button" *ngIf="transactionId" (click)="deleteTransaction()">
      <mat-icon>delete</mat-icon>
    </button>
    <button mat-icon-button>
      <mat-icon>save</mat-icon>
    </button>
  </app-toolbar>
  <mat-tab-group>
    <mat-tab label="Részletek" tabindex="-1">
      <div class="transaction-edit__tab">
        <div>
          <app-datetime-input formControlName="issuedAt">
          </app-datetime-input>
        </div>
        <div class="transaction-edit__amount">
          <app-amount-input formControlName="amount" [currency]="form.value.account.currency">
          </app-amount-input>
        </div>
        <div class="transaction-edit__account">
          <app-autocomplete-input [items]="accounts" label="Számla" displayPropertyName="name"
            formControlName="account"></app-autocomplete-input>
        </div>
        <mat-slide-toggle color="primary" formControlName="isTransfer">Átvitel másik számlára</mat-slide-toggle>
        <div class="transaction-edit__account" *ngIf="isTransfer">
          <app-autocomplete-input [items]="transferAccounts" label="Átvitel {{amount >= 0 ? 'innen' : 'ide'}}"
            displayPropertyName="name" formControlName="transferAccount"></app-autocomplete-input>
        </div>
        <div class="transaction-edit__amount" *ngIf="isTransfer">
          <app-amount-input formControlName="transferAmount" [currency]="form.value.transferAccount?.currency">
          </app-amount-input>
        </div>
        <div class="transaction-edit__category" *ngIf="isPayment">
          <app-autocomplete-input [items]="categories" label="Kategória" displayPropertyName="fullName"
            filterPropertyName="name" formControlName="category"></app-autocomplete-input>
          <button mat-mini-fab color="primary" type="button" (click)="createCategory()">
            <mat-icon>library_add</mat-icon>
          </button>
        </div>
        <app-invoice-input *ngIf="isCategoryType('invoice') && isPayment" formControlName="invoice">
        </app-invoice-input>
        <app-inventory-input *ngIf="isCategoryType('inventory') && isPayment"
          [products]="getProducts(form.value.category.categoryId)" formControlName="inventory">
        </app-inventory-input>
        <div class="transaction-edit__recipient" *ngIf="!isTransfer">
          <app-autocomplete-input [items]="recipients" label="Partner" displayPropertyName="name"
            formControlName="recipient"></app-autocomplete-input>
          <button mat-mini-fab color="primary" type="button" (click)="createRecipient()">
            <mat-icon>library_add</mat-icon>
          </button>
        </div>
        <div class="transaction-edit__project" *ngIf="isPayment">
          <app-autocomplete-input [items]="projects" label="Projekt" displayPropertyName="name"
            formControlName="project"></app-autocomplete-input>
          <button mat-mini-fab color="primary" type="button" (click)="createProject()">
            <mat-icon>library_add</mat-icon>
          </button>
        </div>
        <div class="transaction-edit__description">
          <app-clearable-input formControlName="description" label="Megjegyzés">
          </app-clearable-input>
        </div>
      </div>
    </mat-tab>
    <mat-tab label="Bontás" *ngIf="!isTransfer" tabindex="-1">
      <div class="transaction-edit__tab" formArrayName="splits">
        <p class="transaction-edit__split-amount">
          Összesen: {{form.value.amount}} {{form.value.account.currency}}
          <button mat-mini-fab color="primary" (click)="addSplit()" type="button">
            <mat-icon>add</mat-icon>
          </button>
        </p>
        <p class="transaction-edit__split_diff" *ngIf="splitsDiff !== 0">
          Hiányzó összeg: {{splitsDiff}} {{form.value.account.currency}}
        </p>
        <div *ngFor="let split of form.controls.splits.controls; index as i" [formGroup]="split"
          class="mat-elevation-z2 transaction-edit-split-item">
          <div class="transaction-edit-split-item__details">
            <div class="transaction-edit-split-item__amount">
              <app-amount-input formControlName="amount" [currency]="form.value.account.currency">
              </app-amount-input>
            </div>
            <div class="transaction-edit-split-item__category">
              <app-autocomplete-input [items]="categories" label="Kategória" displayPropertyName="fullName"
                filterPropertyName="name" formControlName="category"></app-autocomplete-input>
              <button mat-mini-fab color="primary" type="button" (click)="createCategory()">
                <mat-icon>library_add</mat-icon>
              </button>
            </div>
            <app-invoice-input *ngIf="isCategoryType('invoice', i)" formControlName="invoice">
            </app-invoice-input>
            <app-inventory-input *ngIf="isCategoryType('inventory', i)"
              [products]="getProducts(split.value.category.categoryId)" formControlName="inventory">
            </app-inventory-input>
            <div class="transaction-edit-split-item__project">
              <app-autocomplete-input [items]="projects" label="Projekt" displayPropertyName="name"
                formControlName="project"></app-autocomplete-input>
              <button mat-mini-fab color="primary" type="button" (click)="createProject()">
                <mat-icon>library_add</mat-icon>
              </button>
            </div>
            <div class="transaction-edit-split-item__description">
              <app-clearable-input formControlName="description" label="Megjegyzés">
              </app-clearable-input>
            </div>
          </div>
          <div class="transaction-edit-split-item__delete">
            <button mat-icon-button color="warn" class="transaction-edit-split-item" (click)="deleteSplit(i)"
              type="button">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </div>
      </div>
    </mat-tab>
  </mat-tab-group>
</form>
